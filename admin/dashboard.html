<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Analytics Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
            color: #ffffff;
            line-height: 1.6;
        }
        
        .dashboard {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .header h1 {
            color: #ff6b35;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .stat-card {
            background: #2a2a2a;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            border: 1px solid #333;
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #ff6b35;
            margin-bottom: 10px;
        }
        
        .stat-label {
            color: #cccccc;
            font-size: 1rem;
        }
        
        .charts-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .chart-container {
            background: #2a2a2a;
            padding: 30px;
            border-radius: 15px;
            border: 1px solid #333;
        }
        
        .chart-title {
            color: #ff6b35;
            font-size: 1.5rem;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .device-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
        }
        
        .device-item {
            text-align: center;
        }
        
        .device-count {
            font-size: 2rem;
            color: #ff6b35;
            font-weight: bold;
        }
        
        .top-pages {
            background: #2a2a2a;
            padding: 30px;
            border-radius: 15px;
            border: 1px solid #333;
        }
        
        .page-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #333;
        }
        
        .page-item:last-child {
            border-bottom: none;
        }

        .two-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }

        .simple-list .page-item span:first-child {
            max-width: 70%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            color: #ddd;
        }
        thead th {
            text-align: left;
            padding: 10px;
            border-bottom: 1px solid #444;
        }
        tbody td {
            padding: 10px;
            border-bottom: 1px solid #333;
            font-size: 0.95rem;
        }
        tbody tr:hover { background: #252525; }
        
        .refresh-btn {
            background: linear-gradient(45deg, #ff6b35, #f7931e);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            margin: 20px auto;
            display: block;
        }
        
        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 53, 0.3);
        }
        
        .loading {
            text-align: center;
            color: #cccccc;
            font-size: 1.2rem;
        }
        
        @media (max-width: 768px) {
            .charts-section {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1>ðŸ“Š Portfolio Analytics Dashboard</h1>
            <p>Real-time insights into your website performance</p>
            <button class="refresh-btn" id="refreshBtn">ðŸ”„ Refresh Data</button>
        </div>
        
        <div id="loading" class="loading">Loading analytics data...</div>
        
        <div id="dashboard-content" style="display: none;">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalVisitors">-</div>
                    <div class="stat-label">Total Visitors</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="uniqueVisitors">-</div>
                    <div class="stat-label">Unique Visitors</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="hireRequests">-</div>
                    <div class="stat-label">Hire Requests</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="newsletterSubs">-</div>
                    <div class="stat-label">Newsletter Subscriptions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="contactMessages">-</div>
                    <div class="stat-label">Contact Messages</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="conversionRate">-</div>
                    <div class="stat-label">Conversion Rate</div>
                </div>
            </div>
            
            <div class="charts-section">
                <div class="chart-container">
                    <h3 class="chart-title">Device Breakdown</h3>
                    <canvas id="deviceChart" height="180"></canvas>
                    <div class="device-stats">
                        <div class="device-item">
                            <div class="device-count" id="desktopCount">-</div>
                            <div>Desktop</div>
                        </div>
                        <div class="device-item">
                            <div class="device-count" id="mobileCount">-</div>
                            <div>Mobile</div>
                        </div>
                        <div class="device-item">
                            <div class="device-count" id="tabletCount">-</div>
                            <div>Tablet</div>
                        </div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <h3 class="chart-title">Quick Stats</h3>
                    <div class="device-stats">
                        <div class="device-item">
                            <div class="device-count" id="todayVisitors">-</div>
                            <div>Today's Visitors</div>
                        </div>
                        <div class="device-item">
                            <div class="device-count" id="cvDownloads">-</div>
                            <div>CV Downloads</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="charts-section">
                <div class="chart-container">
                    <h3 class="chart-title">Top Countries</h3>
                    <canvas id="countriesChart" height="220"></canvas>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title">Top Browsers</h3>
                    <canvas id="browsersChart" height="220"></canvas>
                </div>
            </div>
            
            <div class="top-pages">
                <h3 class="chart-title">Top Pages</h3>
                <div id="topPagesList">
                    <!-- Pages will be loaded here -->
                </div>
            </div>

            <div class="two-col">
                <div class="top-pages simple-list">
                    <h3 class="chart-title">Top Countries</h3>
                    <div id="topCountriesList"></div>
                </div>
                <div class="top-pages simple-list">
                    <h3 class="chart-title">Top Cities</h3>
                    <div id="topCitiesList"></div>
                </div>
            </div>

            <div class="top-pages simple-list" style="margin-top: 30px;">
                <h3 class="chart-title">Top Browsers</h3>
                <div id="topBrowsersList"></div>
            </div>

            <div class="top-pages" style="margin-top: 30px;">
                <h3 class="chart-title">Recent Visitors</h3>
                <div style="overflow-x:auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Masked IP</th>
                                <th>Location</th>
                                <th>Browser/OS</th>
                                <th>Device</th>
                                <th>Referrer</th>
                                <th>Last Seen</th>
                            </tr>
                        </thead>
                        <tbody id="recentVisitorsBody"></tbody>
                    </table>
                </div>
            </div>

            <div class="top-pages" style="margin-top: 30px;">
                <h3 class="chart-title">Visitor Submissions</h3>
                <div style="margin-bottom:12px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
                    <select id="vsType" style="background:#2a2a2a; color:#ddd; border:1px solid #444; padding:8px; border-radius:8px;">
                        <option value="all">All</option>
                        <option value="contact">Contact</option>
                        <option value="hire">Hire</option>
                    </select>
                    <select id="vsStatus" style="background:#2a2a2a; color:#ddd; border:1px solid #444; padding:8px; border-radius:8px;">
                        <option value="">Any status</option>
                        <option value="new">new</option>
                        <option value="read">read</option>
                        <option value="replied">replied</option>
                        <option value="archived">archived</option>
                        <option value="reviewed">reviewed</option>
                        <option value="contacted">contacted</option>
                        <option value="in-progress">in-progress</option>
                        <option value="completed">completed</option>
                        <option value="declined">declined</option>
                    </select>
                    <input id="vsSearch" placeholder="Search name, email, subject..." style="flex:1; min-width:200px; background:#2a2a2a; color:#ddd; border:1px solid #444; padding:8px; border-radius:8px;" />
                    <input type="date" id="vsStart" style="background:#2a2a2a; color:#ddd; border:1px solid #444; padding:8px; border-radius:8px;" />
                    <input type="date" id="vsEnd" style="background:#2a2a2a; color:#ddd; border:1px solid #444; padding:8px; border-radius:8px;" />
                    <button class="refresh-btn" id="vsReload">Load</button>
                </div>
                <div style="overflow-x:auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Name / Email</th>
                                <th>Subject</th>
                                <th>Message</th>
                                <th>Created</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="vsBody"></tbody>
                    </table>
                </div>
                <div id="vsPager" style="text-align:center; margin-top:10px;">
                    <button id="vsPrev" class="refresh-btn" style="padding:8px 16px; display:inline-block;">Prev</button>
                    <span id="vsPageInfo" style="margin:0 10px; color:#ccc;"></span>
                    <button id="vsNext" class="refresh-btn" style="padding:8px 16px; display:inline-block;">Next</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Resolve API base so this page works reliably and cookies match the API origin
        let API_BASE = window.location.origin;
        let API_URL = `${API_BASE}/api/analytics`;
        let apiAvailable = false;

        async function resolveApiBase() {
            // Only same-origin or explicit override to avoid cookie domain mismatch
            const candidates = [];
            const override = localStorage.getItem('API_BASE');
            if (override) candidates.push(override);
            candidates.push(window.location.origin);
            for (const base of [...new Set(candidates)]) {
                try {
                    const resp = await fetch(`${base}/api/health`, { method: 'GET' });
                    if (resp.ok) {
                        API_BASE = base;
                        API_URL = `${base}/api/analytics`;
                        apiAvailable = true;
                        if (API_BASE !== window.location.origin) {
                            window.location.replace(`${API_BASE}/admin/dashboard.html`);
                            return false; // stop further init on this origin
                        }
                        return true;
                    }
                } catch (_) { /* try next */ }
            }
            apiAvailable = false;
            return false;
        }

        async function safeJson(res) {
            if (!res.ok) {
                const text = await res.text().catch(() => '');
                throw new Error(`HTTP ${res.status}: ${text.slice(0, 120)}`);
            }
            return res.json();
        }

        async function loadDashboard() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('dashboard-content').style.display = 'none';
            
            try {
                // Ensure API is reachable (once per load)
                if (!apiAvailable) {
                    await resolveApiBase();
                }
                if (!apiAvailable) {
                    throw new Error('API not available. Start the Node server (npm start).');
                }

                // Load dashboard data
                const token = localStorage.getItem('ADMIN_TOKEN');
                const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
                const response = await fetch(`${API_URL}/dashboard?days=30`, { headers, credentials: token ? 'omit' : 'include' });
                const data = await safeJson(response);
                
                if (data.success) {
                    updateDashboard(data.data);
                }
                
                // Load quick stats
                const statsResponse = await fetch(`${API_URL}/stats`, { headers, credentials: token ? 'omit' : 'include' });
                const statsData = await safeJson(statsResponse);
                
                if (statsData.success) {
                    updateQuickStats(statsData.data);
                }
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
                document.getElementById('loading').innerHTML = 'âŒ Error loading data. Make sure the server is running.';
            }
        }
        
        // Keep references to charts to allow re-render on refresh
        let charts = { device: null, countries: null, browsers: null };

        function updateDashboard(data) {
            const { summary, deviceBreakdown, topPages, topCountries, topCities, topBrowsers, recentVisitors } = data;
            
            // Update summary stats
            document.getElementById('totalVisitors').textContent = summary.totalVisitors;
            document.getElementById('uniqueVisitors').textContent = summary.uniqueVisitors;
            document.getElementById('hireRequests').textContent = summary.hireRequests;
            document.getElementById('newsletterSubs').textContent = summary.newsletterSubscriptions;
            document.getElementById('contactMessages').textContent = summary.contactMessages;
            document.getElementById('conversionRate').textContent = summary.conversionRate + '%';
            
            // Update device breakdown
            const devices = { desktop: 0, mobile: 0, tablet: 0 };
            deviceBreakdown.forEach(device => {
                devices[device._id] = device.count;
            });
            
            document.getElementById('desktopCount').textContent = devices.desktop;
            document.getElementById('mobileCount').textContent = devices.mobile;
            document.getElementById('tabletCount').textContent = devices.tablet;
            renderCharts({ devices, topCountries, topBrowsers });
            
            // Update top pages
            const topPagesList = document.getElementById('topPagesList');
            topPagesList.innerHTML = '';
            
            topPages.forEach(page => {
                const pageItem = document.createElement('div');
                pageItem.className = 'page-item';
                pageItem.innerHTML = `
                    <span>${page._id || 'Homepage'}</span>
                    <span>${page.views} views</span>
                `;
                topPagesList.appendChild(pageItem);
            });

            // Top countries
            const topCountriesList = document.getElementById('topCountriesList');
            topCountriesList.innerHTML = '';
            (topCountries || []).forEach(item => {
                const el = document.createElement('div');
                el.className = 'page-item';
                el.innerHTML = `
                    <span>${item._id || 'Unknown'}</span>
                    <span>${item.count}</span>
                `;
                topCountriesList.appendChild(el);
            });

            // Top cities
            const topCitiesList = document.getElementById('topCitiesList');
            topCitiesList.innerHTML = '';
            (topCities || []).forEach(item => {
                const el = document.createElement('div');
                el.className = 'page-item';
                el.innerHTML = `
                    <span>${item._id || 'Unknown'}</span>
                    <span>${item.count}</span>
                `;
                topCitiesList.appendChild(el);
            });

            // Top browsers
            const topBrowsersList = document.getElementById('topBrowsersList');
            topBrowsersList.innerHTML = '';
            (topBrowsers || []).forEach(item => {
                const el = document.createElement('div');
                el.className = 'page-item';
                el.innerHTML = `
                    <span>${item._id || 'Unknown'}</span>
                    <span>${item.count}</span>
                `;
                topBrowsersList.appendChild(el);
            });

            // Recent visitors
            const tbody = document.getElementById('recentVisitorsBody');
            tbody.innerHTML = '';
            (recentVisitors || []).forEach(v => {
                const tr = document.createElement('tr');
                const dt = v.timestamp ? new Date(v.timestamp) : null;
                tr.innerHTML = `
                    <td>${v.ip || ''}</td>
                    <td>${v.location || ''}</td>
                    <td>${v.browser || ''}</td>
                    <td>${v.device || ''}</td>
                    <td title="${v.referrer}">${(v.referrer || '').slice(0, 40)}</td>
                    <td>${dt ? dt.toLocaleString() : ''}</td>
                `;
                tbody.appendChild(tr);
            });
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('dashboard-content').style.display = 'block';
        }

        function renderCharts({ devices, topCountries, topBrowsers }) {
            // Destroy existing instances
            try { charts.device && charts.device.destroy(); } catch(_) {}
            try { charts.countries && charts.countries.destroy(); } catch(_) {}
            try { charts.browsers && charts.browsers.destroy(); } catch(_) {}

            const deviceCtx = document.getElementById('deviceChart')?.getContext('2d');
            if (deviceCtx && window.Chart) {
                charts.device = new Chart(deviceCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Desktop', 'Mobile', 'Tablet'],
                        datasets: [{
                            data: [devices.desktop || 0, devices.mobile || 0, devices.tablet || 0],
                            backgroundColor: ['#4e79a7', '#f28e2b', '#e15759'],
                            borderColor: '#222',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        plugins: { legend: { labels: { color: '#ddd' } } },
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }

            const countryCtx = document.getElementById('countriesChart')?.getContext('2d');
            const top10Countries = (topCountries || []).slice(0, 10);
            if (countryCtx && window.Chart) {
                charts.countries = new Chart(countryCtx, {
                    type: 'bar',
                    data: {
                        labels: top10Countries.map(c => c._id || 'Unknown'),
                        datasets: [{
                            label: 'Visitors',
                            data: top10Countries.map(c => c.count || 0),
                            backgroundColor: '#59a14f'
                        }]
                    },
                    options: {
                        scales: {
                            x: { ticks: { color: '#ccc' } },
                            y: { ticks: { color: '#ccc' }, beginAtZero: true }
                        },
                        plugins: { legend: { labels: { color: '#ddd' } } },
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }

            const browserCtx = document.getElementById('browsersChart')?.getContext('2d');
            const top7Browsers = (topBrowsers || []).slice(0, 7);
            if (browserCtx && window.Chart) {
                charts.browsers = new Chart(browserCtx, {
                    type: 'pie',
                    data: {
                        labels: top7Browsers.map(b => b._id || 'Unknown'),
                        datasets: [{
                            data: top7Browsers.map(b => b.count || 0),
                            backgroundColor: ['#edc948', '#af7aa1', '#76b7b2', '#59a14f', '#e15759', '#4e79a7', '#f28e2b']
                        }]
                    },
                    options: {
                        plugins: { legend: { labels: { color: '#ddd' } } },
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }
        }
        
        function updateQuickStats(data) {
            document.getElementById('todayVisitors').textContent = data.todayVisitors;
            document.getElementById('cvDownloads').textContent = data.totalNewsletterSubscriptions; // Using newsletter as CV downloads for now
        }
        
        // Visitor Submissions state and functions
        let VS_PAGE = 1;
        const VS_LIMIT = 20;

        function getVsHeaders() {
            const token = localStorage.getItem('ADMIN_TOKEN');
            return token ? { 'Authorization': `Bearer ${token}` } : {};
        }

        async function loadVisitorSubmissions() {
            try {
                const type = document.getElementById('vsType')?.value || 'all';
                const status = document.getElementById('vsStatus')?.value || '';
                const q = document.getElementById('vsSearch')?.value?.trim() || '';
                const start = document.getElementById('vsStart')?.value || '';
                const end = document.getElementById('vsEnd')?.value || '';
                const params = new URLSearchParams();
                if (type && type !== 'all') params.set('type', type);
                if (status) params.set('status', status);
                if (q) params.set('q', q);
                if (start) params.set('startDate', start);
                if (end) params.set('endDate', end);
                params.set('limit', String(VS_LIMIT));
                params.set('page', String(VS_PAGE));

                const url = `${API_BASE}/api/admin/visitor-submissions?` + params.toString();
                const res = await fetch(url, { headers: getVsHeaders(), credentials: 'omit' });
                const json = await safeJson(res);
                renderVisitorSubmissions(json.data || [], json.pagination || { total: 0, page: 1, pages: 1 });
            } catch (e) {
                console.error('Failed to load visitor submissions:', e);
                renderVisitorSubmissions([], { total: 0, page: 1, pages: 1 });
            }
        }

        function renderVisitorSubmissions(items, pagination) {
            const tbody = document.getElementById('vsBody');
            if (!tbody) return;
            tbody.innerHTML = '';
            items.forEach(it => {
                const tr = document.createElement('tr');
                const created = it.createdAt ? new Date(it.createdAt).toLocaleString() : '';
                const subj = (it.subject || '').toString();
                const msg = (it.message || '').toString();
                tr.innerHTML = `
                    <td>${it.type}</td>
                    <td><div>${it.name || ''}</div><div style="color:#aaa; font-size:0.9em;">${it.email || ''}</div></td>
                    <td title="${subj}">${subj.slice(0, 40)}</td>
                    <td title="${msg}">${msg.slice(0, 60)}</td>
                    <td>${created}</td>
                    <td>${it.status || ''}</td>
                `;
                tbody.appendChild(tr);
            });

            const pageInfo = document.getElementById('vsPageInfo');
            if (pageInfo) pageInfo.textContent = `Page ${pagination.page} of ${pagination.pages} (${pagination.total} total)`;

            const prev = document.getElementById('vsPrev');
            const next = document.getElementById('vsNext');
            if (prev) prev.disabled = pagination.page <= 1;
            if (next) next.disabled = pagination.page >= pagination.pages;
        }

        // Load dashboard on page load and wire up events without inline handlers
        document.addEventListener('DOMContentLoaded', async () => {
            const ok = await resolveApiBase();
            if (!ok && API_BASE !== window.location.origin) return; // a redirect was initiated
            // Auth guard: ensure admin session is valid on the same API base; if not, go to that base's login
            try {
                const token = localStorage.getItem('ADMIN_TOKEN');
                const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
                const me = await fetch(`${API_BASE}/api/admin/me`, { method: 'GET', headers, credentials: token ? 'omit' : 'include' });
                if (!me.ok) {
                    window.location.href = `${API_BASE}/admin/login.html`;
                    return;
                }
            } catch (_) {
                window.location.href = `${API_BASE}/admin/login.html`;
                return;
            }
            loadDashboard();
            const btn = document.getElementById('refreshBtn');
            if (btn) btn.addEventListener('click', loadDashboard);

            // Wire up Visitor Submissions controls
            document.getElementById('vsReload')?.addEventListener('click', () => { VS_PAGE = 1; loadVisitorSubmissions(); });
            document.getElementById('vsPrev')?.addEventListener('click', () => { if (VS_PAGE > 1) { VS_PAGE -= 1; loadVisitorSubmissions(); } });
            document.getElementById('vsNext')?.addEventListener('click', () => { VS_PAGE += 1; loadVisitorSubmissions(); });
            // Immediate initial load
            loadVisitorSubmissions();
        });
        
        // Auto-refresh every 5 minutes
        setInterval(loadDashboard, 5 * 60 * 1000);

        // Refresh when a new hire request is created (triggered from main site via localStorage)
        window.addEventListener('storage', (e) => {
            if (e.key === 'hireRequestCreated') {
                loadDashboard();
            }
        });
    </script>
</body>
</html>
